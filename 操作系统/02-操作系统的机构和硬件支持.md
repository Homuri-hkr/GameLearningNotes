### 2.1 操作系统虚拟机

- 配置在裸机上的第一层软件是操作系统，这就构成了操作系统虚拟机，操作系统核心在裸机上运行，应用程序在操作系统上运行
- 扩充后的虚拟机不仅可使用原来裸机提供的基本硬件指令，还可以使用操作系统增加的命令

### 2.2 操作系统的组织结构

- 操作系统的组织结构包括模块结构（描述组成系统的不同功能如何分组和交互）、接口（与系统内部结构密切相关，由操作系统提供给用户、用户程序或上层软件使用）、运行时的组织结构（定义了执行过程存在的实体类型及调用方式）

- 操作系统的设计方法：

  - 单体结构：操作系统是一组过程的集合，每一个过程都定义一个接口，包括入口参数和返回值。过程间可以相互调用不受约束。

    特点：运行效率高，难以理解、难以维护、难以验证正确性

  - 模块结构：通过逻辑独立的模块划分，相关模块间具有良好定义的接口，模块需要封装，数据抽象允许模块隐藏数据结构的实现细节

    特点：系统能作为抽象数据类型或对象方法实现，有利于理解和维护，但是存在潜在的性能退化

  - 可扩展内核结构：将操作系统内核分为基础核心和其他核心功能两部分，基础核心包括必要的功能集合

  - 层次结构：操作系统由若干层组成，每一层提供一套功能，该功能仅仅依赖于该层以内的各层。由内而外依次是系统核（包括初级中断处理、进程控制、进程通信、处理机分派）、存储管理、I/O管理、文件存取、资源分配和调度

- 操作系统运行过程中调用一个给定的操作系统的内部例程有两种方式：

  1. 系统功能调用方式，将操作系统服务作为子例程来提供，操作系统的服务例程以内核功能调用或库函数的方式提供，库函数方式实际上是包装的内核功能
  2. 客户端/服务器方式，将操作系统服务作为系统服务进程来提供，服务请求和服务响应是通过消息传递方式实现的，操作系统通过单独自制的系统进程对外提供服务

### 2.3 处理机的特权级

- 操作系统的管理程序不能被破坏，必须为操作系统提供保护环境。将处理执行时的工作状态区分为不同的态，处理机的态又称为处理机的特权级，即当前处于哪种状态，正在执行哪类程序

- 管态：系统态，操作系统的管理程序执行时机器所处的状态，在此状态下中央处理机可以使用全部机器指令，包括一组特权指令，可以使用所有资源，允许访问整个存储区

- 用户态：目态，用户程序执行时机器所处的状态，在此状态下禁止使用特权指令，不能直接取用资源与改变机器状态，并且只允许用户程序访问自己的存储区域

- 有的操作系统还进一步分了核态和管态，核态拥有上述管态的所有特权，相对之下，管态的特权就小一些

- 核态下的特权指令涉及如下方面：

  - 改变机器状态的指令
  - 修改寄存器的指令
  - 涉及外部设备的输入/输出指令

- 在下列情况用户态会转向管态：

  - 用户进程访问操作系统，要求操作系统的某种服务，称为系统功能的调用
  - 在用户程序执行时，发生一次中断（如IO完成中断
  - 在用户进程中产生一个错误状态，被处理为程序性中断
  - 在用户态下企图执行一条特权指令，作为特殊类型错误并按上述情况处理

  从管态返回目态也是由一条特权指令完成

### 2.4 中断及其处理

- 中断：某个时间发生时，系统中止现行程序的运行、引出处理该事件的程序进行处理，处理完毕后返回断点，继续执行

- 按中断功能分类：

  - 输入输出中断：外部设备或通道正常结束或发生某种错误时发生的中断
  - 外中断：对某台中央处理机的外部非通道式装置所引起的中断
  - 机器故障中断：机器发生故障时产生的中断
  - 程序性中断：程序执行过程中，发现了程序性质的错误或出现了某些程序的特定状态而产生的中断。如内存溢出、用户态执行核态指令、非法操作，特殊状态如逐条指令跟踪、指令地址符合跟踪、转态跟踪、监视等
  - 访管中断：对操作系统提出某种需求时所发出的中断

- 按中断方式分类：

  - 强迫性中断：由某种事故或外部请求信号所引起的
  - 自愿中断：由运行程序请求操作系统服务引起的，除了访管中断属于资源中断，其他的都是强迫性

- 按中断来源分类：

  - 中断：又称外中断，由处理机外部事件引起的中断。在x86中称为异步中断，随着CPU的时钟随机产生的，可能发生在一条指令过程中或之后
  - 俘获：又称内中断，包括访管中断、程序性中断、机器故障中断。在x86中称为同步中断，由CPU控制单元产生，在一条指令执行完毕后才发出

- 向量中断：中断发生时，由中断源自己引导处理机进入中断服务程序的中断过程。每个中断有个独特标识，不需要及你过分析就可以直接转到处理该中断的处理程序

  探询中断：将所有中断类型分为几大类，每一大类中都包含若干个中断类型

  向量中断用空间换时间

- 保护现场：在中断时刻能确保程序继续运行的有关信息，包括后继指令的地址、程序运行状态、指令执行情况、中间结果等，这些存储在一些寄存器或计数器中，中断发生时需要将其存放在内存中

  恢复现场：在程序重新运行之前，把保留的该程序现场信息从主存宏送入相应的计数器以及寄存器中

- 程序状态字：程序执行时机器所处的状态，其存放在特定寄存器中。包括程序当前应执行的指令、当前指令执行情况、处理机所处的状态、程序在执行时应屏蔽的中断、寻址方法、编制、保护键、响应中断的内容

- 中断响应：当中央处理机发现已有中断请求，中止当前程序执行，自动引出中断处理程序的过程

- 软件中断处理过程：

  1. 保护现场和传递参数
  2. 执行相应的中断服务例程
  3. 恢复和退出中断