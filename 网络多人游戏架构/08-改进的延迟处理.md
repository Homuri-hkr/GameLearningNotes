### 8.1 沉默的客户终端

- 所有反欺骗客户端-服务器设置的一个传统需求：服务器是唯一运行最重要模拟的主机。这意味着一个玩家产生动作到这个玩家观察该动作导致的真实游戏状态，总有一些延迟，运行在服务器上的真实模拟通常比远程玩家感觉到的真实模拟早半个往返时间，根据网络流量、物理距离和中间硬件的不同，这个时间可以在100ms以上
- 沉默的终端：客户端个服务器发送输入，服务器进行模拟并返回给客户端显示，这里的客户端不需要对模拟有任何了解，唯一的目的就是发送输入，接受结果状态并把它显示给用户，其保证用户的所有状态都是那个时间点附近绝对正确的状态。因为整个系统的状态总是一致和正确的，被称为保守算法，用延迟为代价保证正确
- 单纯的沉默的终端的问题：
  - 服务器以每帧帧率平滑的渲染运动，但服务器以4帧发送状态，客户端在4帧只能看到同一个画面，若客户端每秒60帧，则实际上只有15帧
  - 在fps游戏中会导致很难瞄准目标

### 8.2 客户端插值

- 客户端插值：客户端游戏不是自动将对象移动到服务器发送来的新位置，而是当收到一个新状态时，使用本地感知过滤器的方法根据时间平滑的插值到这个状态
- 插值周期即从客户端从旧状态插值到新状态需要的时间，数据包周期即从服务器发送两个数据包之间的等待时间，若插值周期小于数据包周期，则在新数据包到来前还是有段时间发生卡顿，所以插值周期应小于等于数据包周期。但若插值周期比服务器周期大，客户端没有立即显示状态，则会造成滞后，所以插值周期应正好等于数据包周期
- 服务器可以通知客户端它打算发送数据包的频率，或客户端凭借经验根据数据包到达的频率计算插值周期。服务器应根据带宽而不是延迟来设置数据包周期，可以认为客户端和服务器之间的网络情况以尽可能高的频率发送数据包，即使用客户端插值方式的游戏玩家感知到的延迟是网络延迟和网络带宽综合的一个因素
- 客户端插值对操作摄像机的游戏有一个潜在的优势，即仅仅操作摄像机几乎不会直接影响游戏模拟，即使影响到了也可以理解更新渲染器的视角变换，这可以让玩家获得及时的反馈
- 客户端插值仍然是一个保守算法：尽管有时表示的状态不完全是服务器复制过来的，仅仅是模拟发送过来的两个之间的状态，而没有猜测服务器的状态，所以不会发生严重的错误

### 8.3 客户端预测

- 客户端预测：为了展示比插值更近的状态，客户端可以接收略旧的状态，并在显示给玩家之前推测近似的最新状态
- 为了推测当前状态，客户端必须能运行与服务器相同的模拟代码，当客户端收到一个状态更新，其知道这是在1/2RTT之前的状态，只需要进行额外的1/2RTT的模拟，当客户端给玩家显示结果时就更接近服务器当前模拟的真正游戏状态，当客户端接受来自服务器下一个状态数据包，内部运行额外1/2RTT的模拟得到新状态，此刻理想情况是该状态与客户端根据上一次接收状态计算得到的当前状态完全一致
- 客户端给服务器发送一个包含基于客户端本地时钟的时间戳的数据包，接收到这个数据包时，服务器复制该时间戳到新数据包并发送给客户端，当客户端收到新数据包时，根据自己的始终从当前的时间中减去旧的时间戳就可以获得确切的RTT 

#### 8.3.1 航位推测法

- 游戏模拟在大多数方面都是确定性的，所以客户端只需通过执行服务器模拟代码的副本来模拟，但对于玩家所操控的对象是不可能完美模拟的。在这种情况下，客户端最好的解决方案是先做一个经过训练的猜测，然后当来自服务器的更新到达时，若有必要就更正该猜测

- 航位猜测法：基于实体继续做当前正在做的事情假设，进行实体行为预测的过程。只要远程玩家不断的做当前正在做的事情，航位推测就能保证客户端游戏能够准确预测当前服务器上的真实世界状态，但当玩家采取了以外行动，客户端模拟就会与真实状态产生分歧，必须被纠正。其称为乐观算法

- 当客户端检测到本地模拟发生错误时：

  - 即时状态更新。只需立即更新到最新状态，玩家可能发现对象跳来跳去，但可能好过错误的数据。即使是即时更新，来自服务器的状态仍然滞后1/2RTT
  - 插值。对于每个错误状态都要计算和存储一个偏移量，用于每一帧。或将对象移动一部分路程，使其更接近正确位置，等待将来的服务器状态继续进行纠正。一种流行的方法是是使用三次样条插值创建路径，以实现位置和速度同时平滑的从预测状态过渡到正确状态
  - 二阶状态调整。若一个几乎静止的对象突然加速，即使插值也可能发生抖动，为了更精细的处理，游戏也可以调整二阶参数如加速度

  快节奏的射击游戏通常为小错误使用插值，大错误使用瞬间移动。慢节奏的游戏可能使用二阶状态调整处理除了最大错误之外的所有错误

- 航位预测不能隐藏延迟，当玩家发起动作需要1/2RTT传到服务器，服务器再通过1/2RTT将调整后的动作传回给客户端，此时才能通过航位预测推断，所以仍存在RTT的延迟

#### 8.3.2 客户端移动预测和重放

- 玩家将发起的输入直接给客户端，客户端用这些输入进行模拟，当输入数据包到达服务器时，服务器也开始模拟。但可以使用使用航位推测远程玩家，但对于本地玩家而言，导致的插值等会一个玩家的动作造成不好的体验
- 一个可能解决方案是对本地玩家完全忽略服务器的状态，客户端只从本地模拟得到玩家的状态，这虽然让玩家有平滑的体验，但对于远程玩家，客户端无法预测远侧玩家的真实位置，本地只有推测值，会导致服务器和客户端以不同的方式解决运算，导致混乱
- 更好的解决方案是当客户端收到来自服务器的状态，客户端使用玩家的输入重新模拟从服务器计算该传入状态起玩家发起的所有状态改变，客户端不是使用航位推测来模拟而是使用玩家精确输入来模拟1/2RTT。通过引入移动概念输入状态和时间戳关联在一起，客户端随时跟踪玩家在做什么，每当输入状态到达本地玩家，客户端可以指出在计算该状态时服务器还没收到哪些移动，然后本地应用这些移动。客户端的预测状态将于服务器保持一致，除非遇到一个意外的、远程玩家发起的事件。
- 移动重放不能处理类似于处理一个新物体的创建，比如开枪，发射火球

#### 8.3.3 通过技巧和优化隐藏延迟

- 几乎所有的视频游戏动作都有通知或者视觉线索来指示事情将要发生（即特效），这些通知持续至少服务器与客户端之间一个通信的来回时间，这意味着客户端可以通过在本地执行适当的模拟和特效给玩家的任何输入提供即使反馈，同时等待服务器更新真实模拟，这并不认为客户端要创建物体，但可以开始播放相应特效和音频，若一切顺利，在施法过程中服务器接受到输入数据包产生物体并把它复制给客户端。若服务器知道玩家被沉默了，但尚未将该信息通知玩家，这个优化就是去意义了，但和优化的好处相比是可以容忍的

### 8.4 服务器端回退

- 客户端预测仍有不好处理的事件，如长距离的即时射击，玩家需要程序完成完美的计算，但对于可能发生错误的航位推测来说是不行的
- 服务器回退：当瞄准和开火时，让服务器状态回退到玩家感受到的那个状态
- 在客户端预测的基础上做出的修改：
  - 远程玩家使用客户端插值，而不是航位推测。服务器需要准确的知道客户端玩家每个时刻看到了什么，而航位预测会给服务器带来额外的复杂度。而客户端插值引入额外的插值，但在移动重放和服务端回退算法，它不会被玩家明显感觉到
  - 本地客户端使用移动预测和移动重放。没有本地移动预测和重放，本地玩家会立即注意到来自网络和客户端插值所增加的延迟
  - 发送给服务器的么个移动数据包中保存客户端视角。客户端应在每个发送的数据包中记录客户端当前插值的两个帧的ID，以及插值进度百分比，这给服务器提供了客户端当时所感知世界的精确指示
  - 在服务器端，存储每个相关对象最近几帧的位置。当传入的客户端输入数据包中包含射击时，查找在射击时刻用于插值的两针，使用数据包中的插值进度百分比将所有相关对象回退到客户端扣动扳机的那一刻，然后使用光线投射法确定是否击中。
- 服务器端回退这对开枪者有良好体验，但对被击中玩家可能造成一些不好的体验